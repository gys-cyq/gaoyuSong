<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="format-detection" content="telephone=no">
<title>南通科技局</title>
<!--<link rel="stylesheet" href="../../static/css/font.css" />-->
<link rel="stylesheet" href="../../lib/layui/css/layui.css" />
<link rel="stylesheet" href="../../css/style.css" />
<!-- 添加企业资质 -->
<style>
    /* img {
        width: 40px;
        height: 40px;
    } */


    .filename {

        width: 80px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

</head>

<body>
    <div class="layui-table-brief" style="margin: 10px">
        <form class="layui-form" id="demofrom">
            <div class="layui-form-item">

                <div class="layui-form-item" >
                    <div class="layui-inline">
                        <label class="layui-form-label">申报资质
                            <span style="color:red;">*</span>
                        </label>
                        <div class="layui-input-inline" style="width: 280px">
                            <select lay-filter="companyType" name="companyType" id="companyType" lay-verify="required" style="width: 280px">
                            </select>
                        </div>
                    </div>

                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">说明

                        </label>
                        <div class="layui-input-inline">
                            <textarea class="layui-textarea" name="description" style="width: 280px"></textarea>
                        </div>
                    </div>

                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label" style="width: auto">附件
                            <span style="color:#2fa4e7;font-size: 10px">(点击下载附件模板)</span>
                        </label>

                    </div>


                    <div class="layui-fluid">
                        <ul id="template" style="display: flex"></ul>
                    </div>

                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">文件</label>
                    <div class="layui-input-inline">
                        <button type="button" class="layui-btn" id="uploadFile">
                            <i class="layui-icon"></i>上传多个文件</button>
                            <input name="files" value="" class="layui-input" style="width: 280px;margin-top: 10px"/>

                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-input-block" style="text-align:center;margin:0 auto;">
                        <button class="layui-btn" lay-submit="" lay-filter="submit">立即提交</button>
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </div>

        </form>
        </div>
        <script type="text/javascript" src="../../js/jquery-3.2.1.min.js"></script>
        <script type="text/javascript" src="../../lib/layui/layui.js"></script>
        <script type="text/javascript" src="../../js/jquery.form.js"></script>
        <script type="text/javascript" src="../../js/main.js"></script>
        <script type="text/javascript">
            var form;
            var layer;
            var date = new Date();
            var files=[];
            var y = date.getFullYear();
            var m = date.getMonth() + 1;
            if (m < 10) {
                m = "0" + m;
            }
            var d = date.getDate();
            if (d < 10) {
                d = "0" + d;
            }
            layui.use(['form', 'layer', 'upload'], function () {
                form = layui.form;
                layer = layui.layer;
                var upload=layui.upload;
                findcompanyTypeAll();
                getTemplateList();
                var purl = '/company/qualifications/apply/'+y+m+d;
                var files1
                var uploadInst = upload.render({
                    elem: '#uploadFile' //绑定元素
                    , url: baseUrl + '/file/upload'   //上传接口
                    , accept: 'file',
                    exts: 'doc|xls|docx|xlsx',
                    multiple: true,
                    method: 'post',
                    data: { token: token, savepath: purl },
                    choose: function (obj) {
                        files1 = this.files = obj.pushFile();
                        layer.load();
                    },
                    done: function (res,index,upload) {
                        //上传完毕回调
                        layer.closeAll('loading');
                        if (res.status == 1) {
                            var data = res.data;
                            if (data != null) {
                               
                                for (var i = 0; i < data.length; i++) {
                                    files.push(data[i]);

                                }
                                console.log(files);
                                $("input[name='files']").val(files);
                            }

                        } else {
                            errmsg(res);
                        }
                        delete files1[index];
                    }
                    , error: function () {
                        //请求异常回调
                    }
                });
                form.on('submit(submit)', function (data) {
                    console.log(JSON.stringify(data.field));
                    var options = {
                        url: baseUrl + '/company/applySeniorCompany',
                        type: 'post',
                        dataType: 'json',
                        timeout: 10000,
                        data: { token: localStorage.getItem('token') },
                        success: function (res) {
                            if (res.status == 1) {
                                layer.alert(res.msg, function () {
                                    var index = parent.layer.getFrameIndex(window.name);
                                    parent.layer.close(index);
                                });

                            } else {
                                layer.msg(res.msg)
                            }

                        }, error: function (data) {

                        }
                    };
                    $("#demofrom").ajaxForm(options);
                    $("#demofrom").submit();
                    return false;
                });
            });
            function findcompanyTypeAll() {
                $.ajax({
                    url: baseUrl + '/companytype/findcompanyTypeAll',
                    type: 'get',
                    dataType: 'json',
                    timeout: 10000,
                    data: { token: localStorage.getItem('token') },
                    success: function (res) {
                        if (res.status == 1) {
                            var data = res.data;
                            var html = ' <option value="">' + '请选择资质' + '</option>';

                            for (var i in data) {
                                var id = data[i].id;
                                var typeName = data[i].typeName;
                                html += ' <option value=' + id + '>' + typeName + '</option>';

                            }
                            $('#companyType').html(html);
                            form.render();
                        } else {
                            errmsg(res);
                        }

                    },
                    error: function (xhr, type, errorThrown) {


                    }
                });
            }
            function getTemplateList() {
                $.ajax({
                    url: baseUrl + '/template/getTemplateList',
                    type: 'get',
                    dataType: 'json',
                    timeout: 10000,
                    data: {
                        token: localStorage.getItem('token'),
                        code: 'C200001'
                    },
                    success: function (res) {
                        if (res.status == 1) {
                            var data = res.data;
                            var html = '';
                            for (var i in data) {
                                var imgurl = baseUrl + '/images/' + data[i].formats + '.png';
                                var downloadurl = baseUrl + '/file/download?path=' + data[i].path;
                                html += '<div style="margin-top:-20px"><a href="' + downloadurl + '">';
                                //                            console.log(baseUrl+'/images/'+obj[i].formats+'.png');
                                html += '<img src="' + imgurl + '" style="width:60px;height:60px"></img>';
                                html += '<div class="filename">' + data[i].filename + '</div>';
                                html += '</a></div>';
                            }
                            $('#template').html(html);
                        } else {
                            layer.msg(res.msg);
                        }

                    },
                    error: function (xhr, type, errorThrown) {

                    }
                });

            }
        </script>

</body>

</html>